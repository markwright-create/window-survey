<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>Window Survey</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#0a0a1a;color:#e0e0e0;min-height:100vh}
button{font-family:inherit;cursor:pointer;border:none;-webkit-appearance:none}
select,input,textarea{font-family:inherit;font-size:16px;-webkit-appearance:none}
.hide{display:none!important}
.hdr{padding:16px;border-bottom:1px solid #222;background:#0f0f20}
.hdr h1{font-size:18px;font-weight:700}
.hdr p{font-size:12px;color:#888;margin-top:4px}
.hdr-row{display:flex;justify-content:space-between;align-items:center}
.stats{display:flex;gap:6px;padding:12px;overflow-x:auto}
.sbox{flex:1;min-width:70px;background:#151528;border:1px solid #252540;border-radius:8px;padding:10px 6px;text-align:center}
.sbox .num{font-size:22px;font-weight:700;font-family:monospace}
.sbox .lbl{font-size:9px;color:#888;text-transform:uppercase;margin-top:2px}
.pbar{margin:0 12px 12px;height:5px;background:#1a1a30;border-radius:3px;overflow:hidden}
.pfill{height:100%;background:#22c55e;border-radius:3px;transition:width .3s}
.flist{padding:8px 12px 30px}
.fbtn{display:flex;align-items:center;gap:10px;width:100%;padding:12px;background:#111125;border:1px solid #222240;border-radius:6px;margin-bottom:6px;text-align:left;color:#e0e0e0}
.fbtn:active{background:#1a1a35}
.flbl{font-size:14px;font-weight:700;font-family:monospace;min-width:32px}
.fbar{flex:1;height:5px;background:#1a1a30;border-radius:3px;overflow:hidden}
.fbar-fill{height:100%;border-radius:3px}
.fcnt{font-size:11px;color:#888;min-width:40px;text-align:right}
.bgrid{padding:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:5px}
.bbtn{border-radius:6px;padding:12px 2px;display:flex;flex-direction:column;align-items:center;gap:1px;color:#e0e0e0;font-size:15px;font-weight:700;font-family:monospace;border:1px solid #333}
.bbtn:active{opacity:.7}
.bbtn small{font-size:7px;text-transform:uppercase;opacity:.7}
.sticky{position:sticky;top:0;z-index:10;background:#0a0a1a;border-bottom:1px solid #222;padding:10px 14px}
.sticky-row{display:flex;justify-content:space-between;align-items:center}
.ref{font-size:18px;font-weight:700;font-family:monospace}
.back{background:none;color:#999;font-size:13px;padding:0;margin-bottom:4px}
.badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;text-transform:uppercase}
.nav-row{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.nbtn{background:#1a1a30;border:1px solid #333;border-radius:4px;color:#aaa;padding:5px 10px;font-size:11px;font-weight:600}
.sbody{padding:14px;max-width:700px}
.sec{background:#111125;border:1px solid #222240;border-radius:8px;padding:14px;margin-bottom:10px}
.sec h3{font-size:13px;font-weight:700;margin-bottom:12px}
.fld{margin-bottom:12px}
.fld label{display:block;font-size:12px;color:#999;margin-bottom:5px;font-weight:500}
.ynrow{display:flex;gap:6px}
.ybtn{flex:1;padding:8px 0;border-radius:4px;font-size:13px;font-weight:600;background:#151528;border:1px solid #333;color:#888;text-align:center}
.ybtn.yes{background:#0a2a15;border-color:#22c55e;color:#22c55e}
.ybtn.no{background:#2a0a0a;border-color:#ef4444;color:#ef4444}
.inp{width:100%;background:#0e0e20;border:1px solid #333;border-radius:4px;color:#e0e0e0;padding:8px 10px;outline:none}
.inp:focus{border-color:#3b82f6}
textarea.inp{resize:vertical;min-height:70px}
.warn{padding:8px;background:#2a1a00;border:1px solid #554400;border-radius:4px;font-size:12px;color:#eab308;margin-bottom:10px}
.pbtn{width:100%;padding:14px;background:#151528;border:2px dashed #333;border-radius:8px;color:#999;font-size:13px;font-weight:600;margin-bottom:10px}
.pgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
.pitem{position:relative;border-radius:6px;overflow:hidden;border:1px solid #333}
.pitem img{width:100%;height:80px;object-fit:cover;display:block}
.prem{position:absolute;top:3px;right:3px;background:#ef4444;border-radius:50%;width:22px;height:22px;color:#fff;font-size:12px;display:flex;align-items:center;justify-content:center}
.ecard{background:#111125;border:2px solid #222240;border-radius:8px;padding:18px;margin-bottom:10px;text-align:left;width:100%;color:#e0e0e0}
.ecard:active{border-color:#444}
.ecard .icon{font-size:24px;margin-bottom:4px}
.ecard .title{font-size:14px;font-weight:700}
.ecard .desc{font-size:12px;color:#888}
.dlbtn{background:#0a2a15;border:1px solid #22c55e44;border-radius:4px;color:#22c55e;padding:10px 18px;font-size:13px;font-weight:600;margin-top:12px;margin-right:8px}
.cpbtn{background:#1a1a30;border:1px solid #333;border-radius:4px;color:#aaa;padding:10px 18px;font-size:13px;font-weight:600;margin-top:12px}
pre.out{background:#0e0e20;border:1px solid #222;border-radius:6px;padding:10px;font-size:10px;color:#999;overflow:auto;max-height:250px;white-space:pre-wrap;word-break:break-all;margin-top:12px}
.status-row{display:flex;align-items:center;gap:8px;margin-top:6px}
.status-row label{font-size:11px;color:#888;white-space:nowrap}
.status-row select{flex:1;background:#0e0e20;border:1px solid #333;border-radius:4px;color:#e0e0e0;padding:6px 8px;font-size:12px;font-weight:600}
.sum-section{background:#111125;border:1px solid #222240;border-radius:8px;padding:14px;margin-bottom:10px}
.sum-section h3{font-size:13px;font-weight:700;margin-bottom:10px;color:#e0e0e0}
.sum-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #1a1a30;font-size:13px}
.sum-row:last-child{border-bottom:none}
.sum-label{color:#999}
.sum-val{font-weight:700;font-family:monospace;font-size:15px}
.sum-highlight{background:#0a2a15;border-color:#22c55e33}
.sum-warn{background:#2a1a00;border-color:#55440033}
</style>
</head>
<body>

<div id="page-dashboard">
  <div class="hdr"><div class="hdr-row"><div><h1>ü™ü Window Bay Survey</h1><p>21 floors √ó 36 bays = 756 windows</p></div><div style="display:flex;gap:6px"><button class="nbtn" onclick="showSummary()">Summary</button><button class="nbtn" onclick="showExport()">Export</button></div></div></div>
  <div class="stats" id="dash-stats"></div>
  <div class="pbar"><div class="pfill" id="dash-pbar"></div></div>
  <div class="flist" id="dash-floors"></div>
</div>

<div id="page-floor" class="hide">
  <div class="sticky">
    <button class="back" onclick="showDashboard()">‚Üê All Floors</button>
    <div class="sticky-row"><h2 id="floor-title"></h2></div>
    <div id="floor-stats" style="display:flex;gap:10px;margin-top:6px;font-size:11px"></div>
    <div class="pbar" style="margin:8px 0 0"><div class="pfill" id="floor-pbar"></div></div>
  </div>
  <div class="bgrid" id="floor-grid"></div>
</div>

<div id="page-survey" class="hide">
  <div class="sticky">
    <div class="sticky-row"><button class="back" id="survey-back">‚Üê Back</button><span class="badge" id="survey-badge"></span></div>
    <div class="sticky-row" style="margin-top:4px">
      <span class="ref" id="survey-ref"></span>
      <div style="display:flex;gap:4px"><button class="nbtn" id="btn-prev">‚óÄ Prev</button><button class="nbtn" id="btn-next">Next ‚ñ∂</button></div>
    </div>
    <div class="nav-row"><button class="nbtn" id="btn-copy">Copy Previous Bay</button></div>
    <div class="status-row">
      <label>Status:</label>
      <select id="status-select" onchange="setStatus(this.value)">
        <option value="not_started">Not Started</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="flagged">Flagged</option>
      </select>
    </div>
  </div>
  <div class="sbody" id="survey-body"></div>
</div>

<div id="page-export" class="hide">
  <div style="padding:14px">
    <button class="back" onclick="showDashboard()">‚Üê Back</button>
    <h2 style="margin:10px 0 16px;font-size:18px">Export Survey Data</h2>
    <button class="ecard" onclick="doHTMLReport()"><div class="icon">üìÑ</div><div class="title">Full HTML Report</div><div class="desc">Read-only app with all data + photos</div></button>
    <button class="ecard" onclick="doCSV()"><div class="icon">üìä</div><div class="title">Export CSV</div><div class="desc">Data for Excel ‚Äî no photos</div></button>
    <button class="ecard" onclick="doReport()"><div class="icon">üìã</div><div class="title">Text Summary</div><div class="desc">Quick findings overview</div></button>
    <div id="export-progress" style="display:none;margin-top:12px;padding:12px;background:#111125;border:1px solid #222240;border-radius:8px">
      <div style="font-size:13px;color:#eab308;margin-bottom:8px" id="export-prog-text">Generating report...</div>
      <div class="pbar"><div class="pfill" id="export-prog-bar" style="width:0%"></div></div>
    </div>
    <div id="export-out"></div>
  </div>
</div>

<div id="page-summary" class="hide">
  <div style="padding:14px">
    <button class="back" onclick="showDashboard()">‚Üê Back</button>
    <h2 style="margin:10px 0 6px;font-size:18px">üìä Costing Summary</h2>
    <p style="font-size:12px;color:#888;margin-bottom:14px">Live quantities from survey data</p>
    <div id="summary-content"></div>
  </div>
</div>

<script>
var FLOORS=21, BAYS=36, TOTAL=756;
var STAT={
  not_started:{c:"#64748b",bg:"#1e293b",l:"Not Started",s:"‚Äî"},
  in_progress:{c:"#eab308",bg:"#422006",l:"In Progress",s:"WIP"},
  completed:{c:"#22c55e",bg:"#052e16",l:"Completed",s:"Done"},
  flagged:{c:"#ef4444",bg:"#450a0a",l:"Flagged",s:"Flag"}
};
var curFloor=null, curBay=null, curData=null;

function skey(f,b){return "ws_"+f+"_"+b}
function load(f,b){try{var d=localStorage.getItem(skey(f,b));return d?JSON.parse(d):null}catch(e){return null}}
function save(f,b,d){try{localStorage.setItem(skey(f,b),JSON.stringify(d))}catch(e){}var idx=getIdx();idx[f+"-"+b]=d.status;try{localStorage.setItem("ws_idx",JSON.stringify(idx))}catch(e){}}
function getIdx(){try{var d=localStorage.getItem("ws_idx");return d?JSON.parse(d):{}}catch(e){return {}}}
function getSt(f,b){var idx=getIdx();return idx[f+"-"+b]||"not_started"}
function emptyData(){return{blinds:null,blindsType:"",blindsCondition:"",blindsRemoval:null,desk:null,deskType:"",deskClearance:null,furniture:null,furnitureNotes:"",insulated:null,insulationType:"",insulationCondition:"",windowType:"",glazing:"",openingMech:"",frameCondition:"",sealantCondition:"",cableRouting:null,cableNotes:"",radiator:null,radiatorType:"",accessDifficulty:"",heightRestriction:null,heightNotes:"",condensation:null,draught:null,internalDamage:"",photos:[],notes:"",status:"not_started",surveyedBy:"",surveyDate:""}}

function hideAll(){
  document.getElementById("page-dashboard").className="hide";
  document.getElementById("page-floor").className="hide";
  document.getElementById("page-survey").className="hide";
  document.getElementById("page-export").className="hide";
  document.getElementById("page-summary").className="hide";
}
function showDashboard(){hideAll();document.getElementById("page-dashboard").className="";renderDashboard()}
function showFloor(f){curFloor=f;hideAll();document.getElementById("page-floor").className="";renderFloor()}
function showSurvey(f,b){curFloor=f;curBay=b;curData=load(f,b)||emptyData();hideAll();document.getElementById("page-survey").className="";renderSurvey()}
function showExport(){hideAll();document.getElementById("page-export").className="";document.getElementById("export-out").innerHTML=""}

function showSummary(){hideAll();document.getElementById("page-summary").className="";renderSummary()}

function renderSummary(){
  var s={surveyed:0,completed:0,flagged:0,
    blindsYes:0,blindsNo:0,blindsRemoval:0,blindsTypes:{},blindsCond:{},
    deskYes:0,deskNo:0,deskClearance:0,deskTypes:{},
    furnitureYes:0,
    insYes:0,insNo:0,insTypes:{},insCond:{},
    winTypes:{},glazTypes:{},openTypes:{},frameCond:{},sealCond:{},
    cableYes:0,cableNo:0,
    radYes:0,radNo:0,radTypes:{},
    accessLevels:{},heightYes:0,
    condYes:0,draughtYes:0,damageYes:0,
    photoCount:0};

  function inc(obj,key){if(!key)return;obj[key]=(obj[key]||0)+1}

  for(var f=1;f<=FLOORS;f++){
    for(var b=1;b<=BAYS;b++){
      var d=load(f,b);
      if(!d||d.status==="not_started")continue;
      s.surveyed++;
      if(d.status==="completed")s.completed++;
      if(d.status==="flagged")s.flagged++;
      if(d.blinds===true){s.blindsYes++;inc(s.blindsTypes,d.blindsType);inc(s.blindsCond,d.blindsCondition);if(d.blindsRemoval===true)s.blindsRemoval++}
      if(d.blinds===false)s.blindsNo++;
      if(d.desk===true){s.deskYes++;inc(s.deskTypes,d.deskType);if(d.deskClearance===true)s.deskClearance++}
      if(d.desk===false)s.deskNo++;
      if(d.furniture===true)s.furnitureYes++;
      if(d.insulated===true){s.insYes++;inc(s.insTypes,d.insulationType);inc(s.insCond,d.insulationCondition)}
      if(d.insulated===false)s.insNo++;
      inc(s.winTypes,d.windowType);inc(s.glazTypes,d.glazing);inc(s.openTypes,d.openingMech);inc(s.frameCond,d.frameCondition);inc(s.sealCond,d.sealantCondition);
      if(d.cableRouting===true)s.cableYes++;if(d.cableRouting===false)s.cableNo++;
      if(d.radiator===true){s.radYes++;inc(s.radTypes,d.radiatorType)}if(d.radiator===false)s.radNo++;
      inc(s.accessLevels,d.accessDifficulty);
      if(d.heightRestriction===true)s.heightYes++;
      if(d.condensation===true)s.condYes++;
      if(d.draught===true)s.draughtYes++;
      if(d.internalDamage)s.damageYes++;
      if(d.photos)s.photoCount+=d.photos.length;
    }
  }

  function row(label,val,color){return '<div class="sum-row"><span class="sum-label">'+label+'</span><span class="sum-val" style="color:'+(color||"#e0e0e0")+'">'+val+'</span></div>'}
  function breakdownRows(obj){var h="";for(var k in obj)h+=row("  "+k,obj[k],"#aaa");return h}

  var h="";

  // Progress
  h+='<div class="sum-section"><h3>üìã Progress</h3>';
  h+=row("Total bays",TOTAL);
  h+=row("Surveyed",s.surveyed,"#3b82f6");
  h+=row("Completed",s.completed,"#22c55e");
  h+=row("Flagged",s.flagged,"#ef4444");
  h+=row("Remaining",TOTAL-s.surveyed,"#eab308");
  h+=row("Photos taken",s.photoCount,"#3b82f6");
  h+='</div>';

  // Blinds
  h+='<div class="sum-section"><h3>ü™ü Blinds ‚Äî Removal & Refit</h3>';
  h+=row("Blinds fitted",s.blindsYes,"#e0e0e0");
  h+=row("No blinds",s.blindsNo);
  h+=row("‚ö° Blinds to remove before works",s.blindsRemoval,"#eab308");
  if(Object.keys(s.blindsTypes).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">BY TYPE</div>';h+=breakdownRows(s.blindsTypes)}
  if(Object.keys(s.blindsCond).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">BY CONDITION</div>';h+=breakdownRows(s.blindsCond)}
  h+='</div>';

  // Desks
  h+='<div class="sum-section"><h3>ü™ë Desk & Furniture Clearance</h3>';
  h+=row("Desks in front of windows",s.deskYes,"#e0e0e0");
  h+=row("No desk",s.deskNo);
  h+=row("‚ö° Desks needing clearance",s.deskClearance,"#eab308");
  h+=row("Other furniture obstructions",s.furnitureYes,"#eab308");
  if(Object.keys(s.deskTypes).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">DESK TYPES</div>';h+=breakdownRows(s.deskTypes)}
  h+='</div>';

  // Insulation
  h+='<div class="sum-section'+(s.insNo>0?" sum-warn":"")+'"><h3>üß± Wall Insulation</h3>';
  h+=row("Insulated",s.insYes,"#22c55e");
  h+=row("‚ö° NOT insulated ‚Äî works needed",s.insNo,"#ef4444");
  if(Object.keys(s.insTypes).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">INSULATION TYPES</div>';h+=breakdownRows(s.insTypes)}
  if(Object.keys(s.insCond).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">INSULATION CONDITION</div>';h+=breakdownRows(s.insCond)}
  h+='</div>';

  // Window types
  h+='<div class="sum-section"><h3>üîç Existing Windows</h3>';
  if(Object.keys(s.winTypes).length>0){h+='<div style="font-size:11px;color:#666;font-weight:600;margin-bottom:4px">WINDOW TYPES</div>';h+=breakdownRows(s.winTypes)}
  if(Object.keys(s.glazTypes).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">GLAZING</div>';h+=breakdownRows(s.glazTypes)}
  if(Object.keys(s.openTypes).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">OPENING MECHANISM</div>';h+=breakdownRows(s.openTypes)}
  if(Object.keys(s.frameCond).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">FRAME CONDITION</div>';h+=breakdownRows(s.frameCond)}
  if(Object.keys(s.sealCond).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">SEALANT CONDITION</div>';h+=breakdownRows(s.sealCond)}
  h+='</div>';

  // Services
  h+='<div class="sum-section"><h3>üîå Services & Access</h3>';
  h+=row("‚ö° Cable routing to reroute",s.cableYes,"#eab308");
  h+=row("No cable routing",s.cableNo);
  h+=row("‚ö° Radiators to remove/refit",s.radYes,"#eab308");
  h+=row("No radiator",s.radNo);
  if(Object.keys(s.radTypes).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">RADIATOR TYPES</div>';h+=breakdownRows(s.radTypes)}
  if(Object.keys(s.accessLevels).length>0){h+='<div style="margin-top:6px;font-size:11px;color:#666;font-weight:600">ACCESS DIFFICULTY</div>';h+=breakdownRows(s.accessLevels)}
  h+=row("‚ö° Height restrictions",s.heightYes,"#eab308");
  h+='</div>';

  // Condition
  h+='<div class="sum-section"><h3>‚ö†Ô∏è Condition Issues</h3>';
  h+=row("Condensation present",s.condYes,"#ef4444");
  h+=row("Draughts present",s.draughtYes,"#ef4444");
  h+=row("Internal damage recorded",s.damageYes,"#ef4444");
  h+='</div>';

  document.getElementById("summary-content").innerHTML=h;
}

function renderDashboard(){
  var idx=getIdx(),done=0,prog=0,flag=0;
  for(var k in idx){if(idx[k]==="completed")done++;else if(idx[k]==="in_progress")prog++;else if(idx[k]==="flagged")flag++}
  var pct=Math.round((done/TOTAL)*100);
  document.getElementById("dash-stats").innerHTML='<div class="sbox"><div class="num" style="color:#e0e0e0">'+pct+'%</div><div class="lbl">Complete</div></div><div class="sbox"><div class="num" style="color:#22c55e">'+done+'</div><div class="lbl">Done</div></div><div class="sbox"><div class="num" style="color:#eab308">'+prog+'</div><div class="lbl">In Progress</div></div><div class="sbox"><div class="num" style="color:#ef4444">'+flag+'</div><div class="lbl">Flagged</div></div>';
  document.getElementById("dash-pbar").style.width=pct+"%";
  var h="";
  for(var f=FLOORS;f>=1;f--){var fc=0,ff=0;for(var b=1;b<=BAYS;b++){var s=getSt(f,b);if(s==="completed")fc++;if(s==="flagged")ff++}var fp=Math.round((fc/BAYS)*100);
    h+='<button class="fbtn" onclick="showFloor('+f+')"><span class="flbl">F'+f+'</span><div class="fbar"><div class="fbar-fill" style="width:'+fp+'%;background:'+(fp===100?"#22c55e":"#3b82f6")+'"></div></div><span class="fcnt">'+fc+'/'+BAYS+'</span>'+(ff>0?'<span style="font-size:10px;color:#ef4444;font-weight:700">‚öë'+ff+'</span>':'')+'</button>'}
  document.getElementById("dash-floors").innerHTML=h;
}

function renderFloor(){
  var f=curFloor;
  document.getElementById("floor-title").textContent="Floor "+f;
  var stats={not_started:0,in_progress:0,completed:0,flagged:0};
  for(var b=1;b<=BAYS;b++){var s=getSt(f,b);stats[s]=(stats[s]||0)+1}
  document.getElementById("floor-pbar").style.width=Math.round((stats.completed/BAYS)*100)+"%";
  var sh="";for(var k in STAT)sh+='<span style="color:'+STAT[k].c+'">'+stats[k]+' '+STAT[k].l+'</span>';
  document.getElementById("floor-stats").innerHTML=sh;
  var h="";
  for(var b=1;b<=BAYS;b++){var st=STAT[getSt(f,b)]||STAT.not_started;
    h+='<button class="bbtn" style="background:'+st.bg+';border-color:'+st.c+'33;color:'+st.c+'" onclick="showSurvey('+f+','+b+')">'+b+'<small>'+st.s+'</small></button>'}
  document.getElementById("floor-grid").innerHTML=h;
}

function renderSurvey(){
  var f=curFloor,b=curBay,d=curData;
  var ref="F"+f+"-B"+(b<10?"0":"")+b;
  var st=STAT[d.status]||STAT.not_started;
  document.getElementById("survey-ref").textContent=ref;
  document.getElementById("survey-badge").textContent=st.l;
  document.getElementById("survey-badge").style.background=st.bg;
  document.getElementById("survey-badge").style.color=st.c;
  document.getElementById("status-select").value=d.status;
  document.getElementById("survey-back").onclick=function(){saveCur();showFloor(f)};
  document.getElementById("btn-prev").style.display=b>1?"":"none";
  document.getElementById("btn-next").style.display=b<BAYS?"":"none";
  document.getElementById("btn-prev").onclick=function(){saveCur();showSurvey(f,b-1)};
  document.getElementById("btn-next").onclick=function(){saveCur();showSurvey(f,b+1)};
  document.getElementById("btn-copy").style.display=b>1?"":"none";
  document.getElementById("btn-copy").onclick=function(){var prev=load(f,b-1);if(prev){curData=JSON.parse(JSON.stringify(prev));curData.photos=[];curData.notes="";curData.surveyDate="";curData.status="in_progress";saveCur();renderSurvey()}};

  var h="";
  h+='<div class="sec"><h3>ü™ü Blinds</h3>';
  h+=mkyn("blinds","Blinds fitted?",d.blinds);
  if(d.blinds===true){h+=mksel("blindsType","Blinds type",d.blindsType,["Vertical","Venetian","Roller","Roman","Pleated","Blackout","Other"]);h+=mksel("blindsCondition","Condition",d.blindsCondition,["Good","Fair","Poor","Damaged","Missing parts"]);h+=mkyn("blindsRemoval","Removal needed?",d.blindsRemoval)}
  h+='</div>';

  h+='<div class="sec"><h3>ü™ë Desk & Furniture</h3>';
  h+=mkyn("desk","Desk in front?",d.desk);
  if(d.desk===true){h+=mksel("deskType","Desk type",d.deskType,["Single desk","Double desk","L-shaped","Bench desk","Standing desk","Fixed pedestal","Other"]);h+=mkyn("deskClearance","Clearance needed?",d.deskClearance)}
  h+=mkyn("furniture","Other furniture?",d.furniture);
  if(d.furniture===true)h+=mktxt("furnitureNotes","Details",d.furnitureNotes,false);
  h+='</div>';

  h+='<div class="sec"><h3>üß± Wall Below Window</h3>';
  h+=mkyn("insulated","Wall insulated?",d.insulated);
  if(d.insulated===true){h+=mksel("insulationType","Type",d.insulationType,["Dry lining","PIR board","Mineral wool","Cavity fill","EWI","Unknown","Other"]);h+=mksel("insulationCondition","Condition",d.insulationCondition,["Good","Fair","Poor","Damaged","Unknown"])}
  if(d.insulated===false)h+='<div class="warn">‚ö† No insulation ‚Äî may need works</div>';
  h+='</div>';

  h+='<div class="sec"><h3>üîç Existing Window</h3>';
  h+=mksel("windowType","Type",d.windowType,["Casement","Tilt & turn","Fixed","Sliding sash","Top hung","Side hung","Pivot","Louvre","Mixed","Other"]);
  h+=mksel("glazing","Glazing",d.glazing,["Single","Double","Triple","Unknown"]);
  h+=mksel("openingMech","Opening mechanism",d.openingMech,["Manual handle","Restrictor stay","Friction hinge","Crank","Motorised","Fixed/Non-opening","Other"]);
  h+=mksel("frameCondition","Frame condition",d.frameCondition,["Good","Fair","Poor","Corroded","Rotten","Damaged"]);
  h+=mksel("sealantCondition","Sealant condition",d.sealantCondition,["Good","Fair","Poor","Failed","Missing"]);
  h+='</div>';

  h+='<div class="sec"><h3>üîå Services & Access</h3>';
  h+=mkyn("cableRouting","Cable routing?",d.cableRouting);
  if(d.cableRouting===true)h+=mktxt("cableNotes","Details",d.cableNotes,false);
  h+=mkyn("radiator","Radiator below?",d.radiator);
  if(d.radiator===true)h+=mksel("radiatorType","Type",d.radiatorType,["Panel","Column","Convector","Trench","Fan coil","Other"]);
  h+=mksel("accessDifficulty","Access difficulty",d.accessDifficulty,["Easy","Moderate","Difficult","Requires scaffold/platform"]);
  h+=mkyn("heightRestriction","Height restrictions?",d.heightRestriction);
  if(d.heightRestriction===true)h+=mktxt("heightNotes","Details",d.heightNotes,false);
  h+='</div>';

  h+='<div class="sec"><h3>‚ö†Ô∏è Condition</h3>';
  h+=mkyn("condensation","Condensation?",d.condensation);
  h+=mkyn("draught","Draught?",d.draught);
  h+=mktxt("internalDamage","Internal damage",d.internalDamage,false);
  h+='</div>';

  h+='<div class="sec"><h3>üì∑ Photos</h3>';
  h+='<input type="file" id="cam" accept="image/*" capture="environment" style="display:none" onchange="addPhoto(this)">';
  h+='<button class="pbtn" onclick="document.getElementById(\'cam\').click()">üì∏ Take Photo / Upload</button>';
  if(d.photos&&d.photos.length>0){h+='<div class="pgrid">';for(var i=0;i<d.photos.length;i++)h+='<div class="pitem"><img src="'+d.photos[i].data+'"><button class="prem" onclick="rmPhoto('+i+')">√ó</button></div>';h+='</div>'}
  h+='</div>';

  h+='<div class="sec"><h3>üìù Details</h3>';
  h+=mktxt("notes","Notes",d.notes,true);
  h+=mktxt("surveyedBy","Surveyed by",d.surveyedBy,false);
  h+=mktxt("surveyDate","Date",d.surveyDate,false,"YYYY-MM-DD");
  h+='</div><div style="height:40px"></div>';

  document.getElementById("survey-body").innerHTML=h;
}

function mkyn(id,label,val){
  return '<div class="fld"><label>'+label+'</label><div class="ynrow"><button class="ybtn'+(val===true?" yes":"")+'" onclick="toggleYN(\''+id+'\',true)">Yes</button><button class="ybtn'+(val===false?" no":"")+'" onclick="toggleYN(\''+id+'\',false)">No</button></div></div>';
}
function mksel(id,label,val,opts){
  var h='<div class="fld"><label>'+label+'</label><select class="inp" onchange="setField(\''+id+'\',this.value)"><option value="">Select...</option>';
  for(var i=0;i<opts.length;i++)h+='<option value="'+opts[i]+'"'+(val===opts[i]?' selected':'')+'>'+opts[i]+'</option>';
  return h+'</select></div>';
}
function mktxt(id,label,val,multi,ph){
  if(multi)return '<div class="fld"><label>'+label+'</label><textarea class="inp" placeholder="'+(ph||"")+'" onchange="setField(\''+id+'\',this.value)">'+(val||'')+'</textarea></div>';
  return '<div class="fld"><label>'+label+'</label><input class="inp" value="'+(val||'')+'" placeholder="'+(ph||"")+'" onchange="setField(\''+id+'\',this.value)"></div>';
}

function toggleYN(id,val){if(curData[id]===val)curData[id]=null;else curData[id]=val;saveCur();renderSurvey()}
function setField(id,val){curData[id]=val;saveCur()}
function setStatus(val){curData.status=val;if(val==="completed"&&!curData.surveyDate)curData.surveyDate=new Date().toISOString().split("T")[0];saveCur();renderSurvey()}
function saveCur(){if(curFloor&&curBay&&curData)save(curFloor,curBay,curData)}

function addPhoto(input){
  var file=input.files&&input.files[0];if(!file)return;
  var reader=new FileReader();
  reader.onload=function(){
    var img=new Image();
    img.onload=function(){
      var MAX=800;
      var w=img.width,h=img.height;
      if(w>MAX){h=Math.round(h*(MAX/w));w=MAX}
      var canvas=document.createElement("canvas");
      canvas.width=w;canvas.height=h;
      var ctx=canvas.getContext("2d");
      ctx.drawImage(img,0,0,w,h);
      var compressed=canvas.toDataURL("image/jpeg",0.7);
      if(!curData.photos)curData.photos=[];
      curData.photos.push({data:compressed,name:file.name,ts:Date.now()});
      saveCur();renderSurvey();
    };
    img.src=reader.result;
  };
  reader.readAsDataURL(file);input.value="";
}
function rmPhoto(i){curData.photos.splice(i,1);saveCur();renderSurvey()}

function doHTMLReport(){
  var prog=document.getElementById("export-progress");
  prog.style.display="block";
  document.getElementById("export-prog-text").textContent="Gathering survey data...";
  document.getElementById("export-prog-bar").style.width="5%";

  setTimeout(function(){
    // Collect all data
    var allData={};
    var photoCount=0;
    for(var f=1;f<=FLOORS;f++){
      for(var b=1;b<=BAYS;b++){
        var d=load(f,b);
        if(d){allData[f+"-"+b]=d;if(d.photos)photoCount+=d.photos.length}
      }
    }
    document.getElementById("export-prog-text").textContent="Building report ("+photoCount+" photos)...";
    document.getElementById("export-prog-bar").style.width="20%";

    setTimeout(function(){
      var yn2=function(v){return v===true?"Yes":v===false?"No":"‚Äî"};
      var val=function(v){return v||"‚Äî"};

      // Build summary data
      var sm={surveyed:0,completed:0,flagged:0,blindsYes:0,blindsRemoval:0,deskYes:0,deskClearance:0,furnitureYes:0,insNo:0,cableYes:0,radYes:0,condYes:0,draughtYes:0,damageYes:0,photos:photoCount};
      for(var k in allData){var d=allData[k];if(d.status==="not_started")continue;sm.surveyed++;
        if(d.status==="completed")sm.completed++;if(d.status==="flagged")sm.flagged++;
        if(d.blinds)sm.blindsYes++;if(d.blindsRemoval)sm.blindsRemoval++;
        if(d.desk)sm.deskYes++;if(d.deskClearance)sm.deskClearance++;if(d.furniture)sm.furnitureYes++;
        if(d.insulated===false)sm.insNo++;if(d.cableRouting)sm.cableYes++;if(d.radiator)sm.radYes++;
        if(d.condensation)sm.condYes++;if(d.draught)sm.draughtYes++;if(d.internalDamage)sm.damageYes++}

      // Build CSV data for embedded export
      var csvHeads=["Reference","Floor","Bay","Status","Blinds","Blinds Type","Blinds Condition","Blinds Removal","Desk","Desk Type","Desk Clearance","Furniture","Furniture Notes","Insulated","Insulation Type","Insulation Condition","Window Type","Glazing","Opening Mech","Frame Condition","Sealant Condition","Cable Routing","Cable Notes","Radiator","Radiator Type","Access Difficulty","Height Restriction","Height Notes","Condensation","Draught","Internal Damage","Notes","Surveyed By","Survey Date"];
      var csvRows=[];
      for(var f=1;f<=FLOORS;f++)for(var b=1;b<=BAYS;b++){var d=allData[f+"-"+b];if(!d)continue;
        csvRows.push(["F"+f+"-B"+(b<10?"0":"")+b,f,b,d.status,yn2(d.blinds),d.blindsType,d.blindsCondition,yn2(d.blindsRemoval),yn2(d.desk),d.deskType,yn2(d.deskClearance),yn2(d.furniture),d.furnitureNotes,yn2(d.insulated),d.insulationType,d.insulationCondition,d.windowType,d.glazing,d.openingMech,d.frameCondition,d.sealantCondition,yn2(d.cableRouting),d.cableNotes,yn2(d.radiator),d.radiatorType,d.accessDifficulty,yn2(d.heightRestriction),d.heightNotes,yn2(d.condensation),yn2(d.draught),d.internalDamage,d.notes,d.surveyedBy,d.surveyDate])}
      var esc=function(v){return '"'+String(v||"").replace(/"/g,'""')+'"'};
      var csvString=csvHeads.map(esc).join(",")+"\n"+csvRows.map(function(r){return r.map(esc).join(",")}).join("\n");
      var csvEncoded=encodeURIComponent(csvString);

      document.getElementById("export-prog-bar").style.width="40%";

      // Build floor detail HTML
      var floorHTML="";
      for(var f=1;f<=FLOORS;f++){
        var bayCards="";
        var floorHasData=false;
        for(var b=1;b<=BAYS;b++){
          var d=allData[f+"-"+b];
          if(!d)continue;
          floorHasData=true;
          var ref="F"+f+"-B"+(b<10?"0":"")+b;
          var stObj={not_started:{c:"#64748b",l:"Not Started"},in_progress:{c:"#eab308",l:"In Progress"},completed:{c:"#22c55e",l:"Completed"},flagged:{c:"#ef4444",l:"Flagged"}};
          var st=stObj[d.status]||stObj.not_started;

          var photoHTML="";
          if(d.photos&&d.photos.length>0){
            photoHTML='<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:8px">';
            for(var p=0;p<d.photos.length;p++){
              photoHTML+='<img src="'+d.photos[p].data+'" style="width:180px;height:120px;object-fit:cover;border-radius:4px;border:1px solid #333">';
            }
            photoHTML+='</div>';
          }

          bayCards+='<div style="background:#111125;border:1px solid #222240;border-radius:8px;padding:14px;margin-bottom:8px" id="bay-'+f+'-'+b+'">';
          bayCards+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><span style="font-size:16px;font-weight:700;font-family:monospace">'+ref+'</span><span style="font-size:10px;font-weight:700;padding:3px 8px;border-radius:4px;color:'+st.c+';background:'+st.c+'15">'+st.l+'</span></div>';

          bayCards+='<table style="width:100%;font-size:12px;border-collapse:collapse">';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888;width:40%">Blinds</td><td style="padding:3px 0">'+yn2(d.blinds)+'</td></tr>';
          if(d.blinds){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Blinds Type</td><td style="padding:3px 0">'+val(d.blindsType)+'</td></tr>';
            bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Blinds Condition</td><td style="padding:3px 0">'+val(d.blindsCondition)+'</td></tr>';
            bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Removal Needed</td><td style="padding:3px 0">'+yn2(d.blindsRemoval)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Desk in Front</td><td style="padding:3px 0">'+yn2(d.desk)+'</td></tr>';
          if(d.desk){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Desk Type</td><td style="padding:3px 0">'+val(d.deskType)+'</td></tr>';
            bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Clearance Needed</td><td style="padding:3px 0">'+yn2(d.deskClearance)+'</td></tr>'}
          if(d.furniture){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Furniture</td><td style="padding:3px 0">'+val(d.furnitureNotes)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Wall Insulated</td><td style="padding:3px 0;'+(d.insulated===false?'color:#ef4444;font-weight:700':'')+'>'+yn2(d.insulated)+'</td></tr>';
          if(d.insulated){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Insulation Type</td><td style="padding:3px 0">'+val(d.insulationType)+'</td></tr>';
            bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Insulation Condition</td><td style="padding:3px 0">'+val(d.insulationCondition)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Window Type</td><td style="padding:3px 0">'+val(d.windowType)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Glazing</td><td style="padding:3px 0">'+val(d.glazing)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Opening Mechanism</td><td style="padding:3px 0">'+val(d.openingMech)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Frame Condition</td><td style="padding:3px 0">'+val(d.frameCondition)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Sealant Condition</td><td style="padding:3px 0">'+val(d.sealantCondition)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Cable Routing</td><td style="padding:3px 0">'+yn2(d.cableRouting)+'</td></tr>';
          if(d.cableRouting&&d.cableNotes){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Cable Notes</td><td style="padding:3px 0">'+val(d.cableNotes)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Radiator</td><td style="padding:3px 0">'+yn2(d.radiator)+'</td></tr>';
          if(d.radiator){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Radiator Type</td><td style="padding:3px 0">'+val(d.radiatorType)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Access Difficulty</td><td style="padding:3px 0">'+val(d.accessDifficulty)+'</td></tr>';
          if(d.heightRestriction){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Height Restriction</td><td style="padding:3px 0">'+val(d.heightNotes)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Condensation</td><td style="padding:3px 0;'+(d.condensation?'color:#ef4444':'')+'">'+yn2(d.condensation)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Draught</td><td style="padding:3px 0;'+(d.draught?'color:#ef4444':'')+'">'+yn2(d.draught)+'</td></tr>';
          if(d.internalDamage){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Damage</td><td style="padding:3px 0;color:#ef4444">'+val(d.internalDamage)+'</td></tr>'}
          if(d.notes){bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Notes</td><td style="padding:3px 0">'+val(d.notes)+'</td></tr>'}
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Surveyed By</td><td style="padding:3px 0">'+val(d.surveyedBy)+'</td></tr>';
          bayCards+='<tr><td style="padding:3px 8px 3px 0;color:#888">Date</td><td style="padding:3px 0">'+val(d.surveyDate)+'</td></tr>';
          bayCards+='</table>';
          bayCards+=photoHTML;
          bayCards+='</div>';
        }

        if(floorHasData){
          var fc=0,ff=0;
          for(var b=1;b<=BAYS;b++){var dd=allData[f+"-"+b];if(dd&&dd.status==="completed")fc++;if(dd&&dd.status==="flagged")ff++}
          floorHTML+='<div style="margin-bottom:20px" id="floor-'+f+'">';
          floorHTML+='<div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:2px solid #222;margin-bottom:10px;cursor:pointer" onclick="var el=document.getElementById(\'fbody-'+f+'\');el.style.display=el.style.display===\'none\'?\'block\':\'none\'">';
          floorHTML+='<h2 style="font-size:16px;font-weight:700">Floor '+f+'</h2>';
          floorHTML+='<div style="display:flex;gap:8px;font-size:11px"><span style="color:#22c55e">'+fc+' done</span>'+(ff>0?'<span style="color:#ef4444">'+ff+' flagged</span>':'')+'<span style="color:#888">‚ñº</span></div>';
          floorHTML+='</div>';
          floorHTML+='<div id="fbody-'+f+'">'+bayCards+'</div>';
          floorHTML+='</div>';
        }
      }

      document.getElementById("export-prog-text").textContent="Assembling HTML file...";
      document.getElementById("export-prog-bar").style.width="70%";

      setTimeout(function(){
        // Build the full HTML
        var html='<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Window Bay Survey Report</title>';
        html+='<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#0a0a1a;color:#e0e0e0;min-height:100vh}';
        html+='.nav{position:sticky;top:0;z-index:10;background:#0f0f20;border-bottom:1px solid #222;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px}';
        html+='.nav h1{font-size:16px;font-weight:700}.nav-btn{background:#1a1a30;border:1px solid #333;border-radius:4px;color:#aaa;padding:6px 12px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}';
        html+='.nav-btn:active{background:#252540}.section{display:none;padding:14px}.section.active{display:block}';
        html+='.sum-card{background:#111125;border:1px solid #222240;border-radius:8px;padding:14px;margin-bottom:10px}';
        html+='.sum-row{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #1a1a30;font-size:13px}.sum-row:last-child{border-bottom:none}';
        html+='.sum-label{color:#888}.sum-val{font-weight:700;font-family:monospace;font-size:14px}';
        html+='table{width:100%}td{padding:3px 0}';
        html+='</style></head><body>';

        // Nav bar
        html+='<div class="nav"><h1>ü™ü Window Bay Survey Report</h1><div style="display:flex;gap:6px;flex-wrap:wrap">';
        html+='<button class="nav-btn" onclick="show(\'summary\')">Summary</button>';
        for(var f=1;f<=FLOORS;f++){
          var hasData=false;for(var b=1;b<=BAYS;b++){if(allData[f+"-"+b]){hasData=true;break}}
          if(hasData)html+='<button class="nav-btn" onclick="show(\'floor-'+f+'\');document.getElementById(\'floor-'+f+'\').scrollIntoView()">F'+f+'</button>';
        }
        html+='<button class="nav-btn" onclick="exportCSV()" style="background:#0a2a15;color:#22c55e;border-color:#22c55e33">‚¨á CSV</button>';
        html+='</div></div>';

        // Summary section
        html+='<div class="section active" id="sec-summary" style="padding:14px">';
        html+='<h2 style="font-size:18px;margin-bottom:4px">üìä Costing Summary</h2>';
        html+='<p style="font-size:12px;color:#888;margin-bottom:14px">Generated: '+new Date().toLocaleDateString()+'</p>';

        html+='<div class="sum-card"><h3 style="font-size:13px;font-weight:700;margin-bottom:8px">üìã Progress</h3>';
        html+='<div class="sum-row"><span class="sum-label">Total bays</span><span class="sum-val">'+TOTAL+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Surveyed</span><span class="sum-val" style="color:#3b82f6">'+sm.surveyed+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Completed</span><span class="sum-val" style="color:#22c55e">'+sm.completed+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Flagged</span><span class="sum-val" style="color:#ef4444">'+sm.flagged+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Photos</span><span class="sum-val" style="color:#3b82f6">'+sm.photos+'</span></div>';
        html+='</div>';

        html+='<div class="sum-card"><h3 style="font-size:13px;font-weight:700;margin-bottom:8px">ü™ü Prelim Works</h3>';
        html+='<div class="sum-row"><span class="sum-label">Blinds to remove</span><span class="sum-val" style="color:#eab308">'+sm.blindsRemoval+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Desks to clear</span><span class="sum-val" style="color:#eab308">'+sm.deskClearance+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Furniture obstructions</span><span class="sum-val" style="color:#eab308">'+sm.furnitureYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Cable routing to reroute</span><span class="sum-val" style="color:#eab308">'+sm.cableYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Radiators to remove/refit</span><span class="sum-val" style="color:#eab308">'+sm.radYes+'</span></div>';
        html+='</div>';

        html+='<div class="sum-card"><h3 style="font-size:13px;font-weight:700;margin-bottom:8px">üß± Additional Works</h3>';
        html+='<div class="sum-row"><span class="sum-label">Bays needing insulation</span><span class="sum-val" style="color:#ef4444">'+sm.insNo+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Condensation issues</span><span class="sum-val" style="color:#ef4444">'+sm.condYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Draught issues</span><span class="sum-val" style="color:#ef4444">'+sm.draughtYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Internal damage</span><span class="sum-val" style="color:#ef4444">'+sm.damageYes+'</span></div>';
        html+='</div>';

        html+='<div class="sum-card"><h3 style="font-size:13px;font-weight:700;margin-bottom:8px">üìä Totals</h3>';
        html+='<div class="sum-row"><span class="sum-label">Blinds fitted</span><span class="sum-val">'+sm.blindsYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Desks in front</span><span class="sum-val">'+sm.deskYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Radiators present</span><span class="sum-val">'+sm.radYes+'</span></div>';
        html+='<div class="sum-row"><span class="sum-label">Cable routing present</span><span class="sum-val">'+sm.cableYes+'</span></div>';
        html+='</div>';
        html+='</div>';

        // Floors section
        html+='<div class="section active" id="sec-floors" style="padding:14px">';
        html+='<h2 style="font-size:18px;margin-bottom:14px">Floor Details</h2>';
        html+=floorHTML;
        html+='</div>';

        // Script for navigation and CSV
        html+='<script>';
        html+='function show(id){var secs=document.querySelectorAll(".section");for(var i=0;i<secs.length;i++)secs[i].className="section active"}';
        html+='var csvData="'+csvEncoded+'";';
        html+='function exportCSV(){var csv=decodeURIComponent(csvData);var blob=new Blob([csv],{type:"text/csv"});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download="window-survey.csv";a.click();URL.revokeObjectURL(url)}';
        html+='<\/script>';
        html+='</body></html>';

        document.getElementById("export-prog-text").textContent="Done! Downloading...";
        document.getElementById("export-prog-bar").style.width="100%";

        // Download
        var blob=new Blob([html],{type:"text/html"});
        var url=URL.createObjectURL(blob);
        var a=document.createElement("a");
        a.href=url;a.download="window-survey-report.html";a.click();
        URL.revokeObjectURL(url);

        setTimeout(function(){prog.style.display="none"},3000);
      },100);
    },100);
  },100);
}

function doCSV(){
  var heads=["Reference","Floor","Bay","Status","Blinds","Blinds Type","Blinds Condition","Blinds Removal","Desk","Desk Type","Desk Clearance","Furniture","Furniture Notes","Insulated","Insulation Type","Insulation Condition","Window Type","Glazing","Opening Mech","Frame Condition","Sealant Condition","Cable Routing","Cable Notes","Radiator","Radiator Type","Access Difficulty","Height Restriction","Height Notes","Condensation","Draught","Internal Damage","Notes","Surveyed By","Survey Date"];
  var rows=[],yn2=function(v){return v===true?"Yes":v===false?"No":""};
  for(var f=1;f<=FLOORS;f++)for(var b=1;b<=BAYS;b++){var d=load(f,b);if(!d)continue;
    rows.push(["F"+f+"-B"+(b<10?"0":"")+b,f,b,d.status,yn2(d.blinds),d.blindsType,d.blindsCondition,yn2(d.blindsRemoval),yn2(d.desk),d.deskType,yn2(d.deskClearance),yn2(d.furniture),d.furnitureNotes,yn2(d.insulated),d.insulationType,d.insulationCondition,d.windowType,d.glazing,d.openingMech,d.frameCondition,d.sealantCondition,yn2(d.cableRouting),d.cableNotes,yn2(d.radiator),d.radiatorType,d.accessDifficulty,yn2(d.heightRestriction),d.heightNotes,yn2(d.condensation),yn2(d.draught),d.internalDamage,d.notes,d.surveyedBy,d.surveyDate])}
  var esc=function(v){return '"'+String(v||"").replace(/"/g,'""')+'"'};
  var csv=heads.map(esc).join(",")+"\n"+rows.map(function(r){return r.map(esc).join(",")}).join("\n");
  showResult(csv,"window-survey.csv","text/csv");
}

function doReport(){
  var s={total:0,completed:0,flagged:0,blinds:0,desks:0,noIns:0,cable:0,rads:0,cond:0,draught:0,items:[]};
  for(var f=1;f<=FLOORS;f++)for(var b=1;b<=BAYS;b++){var d=load(f,b);if(!d||d.status==="not_started")continue;s.total++;
    if(d.status==="completed")s.completed++;if(d.status==="flagged"){s.flagged++;s.items.push("F"+f+"-B"+b+": "+(d.notes||"No notes"))}
    if(d.blinds)s.blinds++;if(d.desk)s.desks++;if(d.insulated===false)s.noIns++;if(d.cableRouting)s.cable++;if(d.radiator)s.rads++;if(d.condensation)s.cond++;if(d.draught)s.draught++}
  var r="WINDOW BAY SURVEY ‚Äî SUMMARY REPORT\nGenerated: "+new Date().toLocaleDateString()+"\n=============================================\n\nPROGRESS\n  Surveyed: "+s.total+" / "+TOTAL+"\n  Completed: "+s.completed+"\n  Flagged: "+s.flagged+"\n\nKEY FINDINGS\n  Blinds fitted: "+s.blinds+"\n  Desks in front: "+s.desks+"\n  No insulation: "+s.noIns+"\n  Cable routing: "+s.cable+"\n  Radiators: "+s.rads+"\n  Condensation: "+s.cond+"\n  Draughts: "+s.draught+"\n\nFLAGGED ITEMS\n"+(s.items.length?s.items.map(function(x){return "  - "+x}).join("\n"):"  None")+"\n";
  showResult(r,"survey-report.txt","text/plain");
}

function showResult(content,filename,type){
  var el=document.getElementById("export-out");
  el.innerHTML='<button class="dlbtn" id="dl-btn">‚¨á Download '+filename+'</button><button class="cpbtn" id="cp-btn">üìã Copy</button><pre class="out">'+content.substring(0,3000)+(content.length>3000?"\n...":"")+'</pre>';
  document.getElementById("dl-btn").onclick=function(){var blob=new Blob([content],{type:type});var url=URL.createObjectURL(blob);var a=document.createElement("a");a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url)};
  document.getElementById("cp-btn").onclick=function(){navigator.clipboard.writeText(content);this.textContent="‚úì Copied!";var self=this;setTimeout(function(){self.textContent="üìã Copy"},2000)};
}

showDashboard();
</script>
</body>
</html>
